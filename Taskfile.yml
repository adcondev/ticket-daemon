version: '3'

# Carga variables desde el archivo .env automÃ¡ticamente
dotenv: [ '.env' ]

vars:
  # Ruta del paquete de configuraciÃ³n donde estÃ¡n las variables globales
  CONFIG_PKG: github.com/adcondev/ticket-daemon/internal/config
  BINARY_NAME: R2k_TicketServicio_Local.exe

tasks:
  build:
    desc: Compila el servicio inyectando credenciales desde .env (Modo Consola)
    cmds:
      - echo "ðŸ”¨ Compilando {{.BINARY_NAME}}..."
      # Se usa -ldflags para inyectar las variables en tiempo de compilaciÃ³n.
      # Se eliminÃ³ -H=windowsgui para permitir ver logs en consola.
      - >
        go build -ldflags "-s -w
        -X '{{.CONFIG_PKG}}.AuthToken={{.TICKET_AUTH_TOKEN}}'
        -X '{{.CONFIG_PKG}}.PasswordHashB64={{.TICKET_DASHBOARD_HASH}}'
        -X '{{.CONFIG_PKG}}.BuildEnvironment={{.BUILD_ENV}}'
        -X '{{.CONFIG_PKG}}.ServiceName=R2k_TicketServicio'"
        -o bin/{{.BINARY_NAME}} ./cmd/TicketServicio
      - echo "âœ… CompilaciÃ³n exitosa en bin/{{.BINARY_NAME}}"

  run:
    desc: Compila y ejecuta inmediatamente
    deps: [ build ]
    cmds:
      - ./bin/{{.BINARY_NAME}} -console

  clean:
    desc: Limpia los artefactos de compilaciÃ³n
    cmds:
      - cmd: rm -rf bin/
        platforms: [ linux, darwin ]
      - cmd: powershell -Command "Remove-Item -Recurse -Force bin/"
        platforms: [ windows ]
      - echo "ðŸ§¹ Limpieza completada"