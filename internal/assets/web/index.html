<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé´ Ticket Daemon | Centro de Control</title>
  <style>
    /* ============================================================
       VARIABLES RA√çZ
       ============================================================ */
    :root {
      --bg-dark: #0a0e17;
      --bg-panel: #12181f;
      --bg-card: #1a222d;
      --bg-input: #232d3b;
      --bg-hover: #2a3647;
      --border: #2d3a4d;
      --border-light: #3d4f66;
      --text-main: #e8edf5;
      --text-muted: #7a8599;
      --text-dim: #4a5568;

      /* Colores de Estado Vibrantes */
      --c-success: #10b981;
      --c-success-bg: rgba(16, 185, 129, 0.15);
      --c-error: #ef4444;
      --c-error-bg: rgba(239, 68, 68, 0.15);
      --c-warning: #f59e0b;
      --c-warning-bg: rgba(245, 158, 11, 0.15);
      --c-info: #3b82f6;
      --c-info-bg: rgba(59, 130, 246, 0.15);
      --c-sent: #a855f7;
      --c-sent-bg: rgba(168, 85, 247, 0.15);
      --c-accent: #06b6d4;
      --c-accent-bg: rgba(6, 182, 212, 0.1);

      /* Degradados */
      --gradient-header: linear-gradient(135deg, #1a222d 0%, #0f1419 100%);
      --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --gradient-error: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      --gradient-info: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      --gradient-accent: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-main);
      display: grid;
      grid-template-rows: 56px 1fr;
      height: 100vh;
      overflow: hidden;
      line-height: 1.5;
    }

    /* Barra de desplazamiento personalizada */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ============================================================
       ENCABEZADO (HEADER)
       ============================================================ */
    header {
      background: var(--gradient-header);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 36px;
      height: 36px;
      background: var(--gradient-accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .brand-text {
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: -0.5px;
    }

    .brand-text span {
      color: var(--c-accent);
    }

    .header-center {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .header-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: var(--bg-card);
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
    }

    .header-stat-label {
      color: var(--text-muted);
    }

    .header-stat-value {
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .header-stat-value.success {
      color: var(--c-success);
    }

    .header-stat-value.error {
      color: var(--c-error);
    }

    .conn-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    .conn-badge.online {
      background: var(--c-success-bg);
      color: var(--c-success);
      border: 1px solid var(--c-success);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
    }

    .conn-badge.offline {
      background: var(--c-error-bg);
      color: var(--c-error);
      border: 1px solid var(--c-error);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
    }

    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(0.9);
      }
    }

    /* ============================================================
       DASHBOARD PRINCIPAL - Dise√±o de 3 Columnas
       ============================================================ */
    .dashboard {
      display: grid;
      grid-template-columns: 320px 1fr 400px;
      gap: 1px;
      background: var(--border);
      overflow: hidden;
    }

    .panel {
      background: var(--bg-panel);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 20px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .panel-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-main);
    }

    .panel-title-icon {
      font-size: 1.1rem;
    }

    .panel-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* ============================================================
       PANEL IZQUIERDO - Estado del Sistema
       ============================================================ */
    .metrics-grid {
      display: grid;
      gap: 12px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .metric-card:hover {
      border-color: var(--border-light);
      transform: translateY(-1px);
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .metric-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .metric-icon {
      font-size: 1rem;
      opacity: 0.7;
    }

    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .metric-value.success {
      color: var(--c-success);
    }

    .metric-value.error {
      color: var(--c-error);
    }

    .metric-value.warning {
      color: var(--c-warning);
    }

    .metric-value.info {
      color: var(--c-info);
    }

    .metric-value.muted {
      color: var(--text-muted);
    }

    .metric-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Progreso de la Cola */
    .queue-bar-container {
      margin-top: 12px;
    }

    .queue-bar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .queue-bar-track {
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      overflow: hidden;
    }

    .queue-bar-fill {
      height: 100%;
      background: var(--gradient-info);
      border-radius: 4px;
      transition: width 0.4s ease, background 0.3s ease;
    }

    .queue-bar-fill.warning {
      background: var(--gradient-error);
    }

    /* Divisores de Secci√≥n */
    .section-label {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin: 24px 0 12px;
    }

    .section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* Botones */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-input);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      margin-bottom: 8px;
    }

    .btn:hover:not(:disabled) {
      background: var(--bg-hover);
      border-color: var(--border-light);
      transform: translateY(-1px);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--gradient-accent);
      border-color: var(--c-accent);
      color: #fff;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.25);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.35);
    }

    .btn-danger {
      background: var(--c-error-bg);
      border-color: var(--c-error);
      color: var(--c-error);
    }

    .btn-danger:hover:not(:disabled) {
      background: var(--c-error);
      color: #fff;
    }

    .btn-sm {
      padding: 8px 12px;
      font-size: 0.8rem;
      width: auto;
      margin: 0;
    }

    .btn-icon {
      padding: 8px;
      width: auto;
      min-width: 36px;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .btn-group.btn {
      margin: 0;
    }

    /* Select */
    select {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-input);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      cursor: pointer;
      margin-bottom: 8px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237a8599' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    select:focus {
      outline: none;
      border-color: var(--c-accent);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.15);
    }

    /* Soluci√≥n de Problemas (Troubleshooting) */
    .troubleshoot-card {
      background: var(--bg-card);
      border: 1px dashed var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-top: auto;
    }

    .troubleshoot-header {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
    }

    .troubleshoot-header:hover {
      background: var(--bg-hover);
    }

    .troubleshoot-header-text {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .troubleshoot-chevron {
      transition: transform 0.2s;
      color: var(--text-muted);
    }

    .troubleshoot-card.open .troubleshoot-chevron {
      transform: rotate(180deg);
    }

    .troubleshoot-body {
      display: none;
      padding: 16px;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-muted);
      max-height: 300px;
      overflow-y: auto;
    }

    .troubleshoot-card.open .troubleshoot-body {
      display: block;
    }

    .troubleshoot-section {
      margin-bottom: 16px;
    }

    .troubleshoot-section:last-child {
      margin-bottom: 0;
    }

    .troubleshoot-section h4 {
      color: var(--c-warning);
      font-size: 0.8rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .troubleshoot-section ul {
      padding-left: 20px;
      margin: 0;
    }

    .troubleshoot-section li {
      margin-bottom: 4px;
    }

    .troubleshoot-section code {
      background: var(--bg-dark);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Cascadia Code', 'Fira Code', monospace;
      font-size: 0.7rem;
    }

    /* ============================================================
       PANEL CENTRAL - Editor JSON
       ============================================================ */
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #jsonEditor {
      width: 100%;
      flex: 1;
      min-height: 400px;
      background: var(--bg-input);
      color: #e2e8f0;
      border: 1px solid var(--border);
      border-radius: 6px;
      resize: none;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      padding: 16px;
      outline: none;
    }

    #jsonEditor:focus {
      border-color: var(--c-accent);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .editor-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0 0;
      gap: 12px;
      flex-shrink: 0;
    }

    .editor-stats {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .editor-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .json-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .json-status.valid {
      background: var(--c-success-bg);
      color: var(--c-success);
    }

    .json-status.invalid {
      background: var(--c-error-bg);
      color: var(--c-error);
    }

    .editor-actions {
      display: flex;
      gap: 8px;
    }

    /* ============================================================
       PANEL DERECHO - Log de Transacciones
       ============================================================ */
    .log-container {
      flex: 1;
      overflow-y: auto;
      background: var(--bg-dark);
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 0.75rem;
    }

    .log-entry {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 16px;
      border-bottom: 1px solid rgba(45, 58, 77, 0.5);
      transition: background 0.15s;
    }

    .log-entry:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .log-time {
      color: var(--text-dim);
      font-size: 0.7rem;
      flex-shrink: 0;
      min-width: 70px;
      font-variant-numeric: tabular-nums;
    }

    .log-badge {
      flex-shrink: 0;
      min-width: 60px;
      padding: 3px 8px;
      text-align: center;
      border-radius: 4px;
      font-weight: 700;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* Colores vibrantes para los badges del log */
    .log-badge.sent {
      background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
    }

    .log-badge.ack {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .log-badge.result {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .log-badge.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .log-badge.info {
      background: var(--bg-input);
      color: var(--text-muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .log-badge.pong {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
    }

    .log-badge.status {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
    }

    .log-message {
      flex: 1;
      word-break: break-word;
      color: var(--text-main);
      line-height: 1.5;
    }

    .log-message.error-text {
      color: var(--c-error);
    }

    .log-message.success-text {
      color: var(--c-success);
    }

    /* Footer del Log */
    .log-footer {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .log-footer.btn {
      flex: 1;
      margin: 0;
    }

    /* ============================================================
       MODAL
       ============================================================ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-box {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .modal-icon {
      font-size: 3.5rem;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .modal-text {
      color: var(--text-muted);
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-buttons.btn {
      flex: 1;
      margin: 0;
    }

    /* ============================================================
       NOTIFICACIONES (TOASTS)
       ============================================================ */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: toastIn 0.3s ease-out;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      min-width: 280px;
    }

    .toast.success {
      border-left: 4px solid var(--c-success);
    }

    .toast.error {
      border-left: 4px solid var(--c-error);
    }

    .toast.warning {
      border-left: 4px solid var(--c-warning);
    }

    .toast.info {
      border-left: 4px solid var(--c-info);
    }

    .toast-icon {
      font-size: 1.2rem;
    }

    .toast-message {
      flex: 1;
      font-size: 0.85rem;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* ============================================================
       RESPONSIVE
       ============================================================ */
    @media (max-width: 1400px) {
      .dashboard {
        grid-template-columns: 280px 1fr 360px;
      }
    }

    @media (max-width: 1100px) {
      .dashboard {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }

      .panel:first-child {
        max-height: 280px;
      }

      .panel:last-child {
        max-height: 300px;
      }

      .header-center {
        display: none;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-icon">üé´</div>
    <div class="brand-text">Ticket <span>Daemon</span></div>
  </div>

  <div class="header-center">
    <div class="header-stat">
      <span class="header-stat-label">Uptime: </span>
      <span class="header-stat-value" id="uptimeVal">--</span>
    </div>
    <div class="header-stat">
      <span class="header-stat-label">Procesados:</span>
      <span class="header-stat-value success" id="processedVal">0</span>
    </div>
    <div class="header-stat">
      <span class="header-stat-label">Fallidos:</span>
      <span class="header-stat-value error" id="failedVal">0</span>
    </div>
  </div>

  <div id="connStatus" class="conn-badge offline">
    <span class="conn-dot"></span>
    <span>Conectando...</span>
  </div>
</header>

<div class="dashboard">

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <span class="panel-title-icon">üìä</span>
        Estado del Sistema
      </div>
      <button class="btn btn-icon btn-sm" id="btnRefresh" title="Actualizar">üîÑ</button>
    </div>
    <div class="panel-content">

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-label">Cola (Queue)</span>
            <span class="metric-icon">üìã</span>
          </div>
          <div class="metric-value info" id="queueVal">0 / 100</div>
          <div class="queue-bar-container">
            <div class="queue-bar-labels">
              <span>0%</span>
              <span id="queuePct">0%</span>
            </div>
            <div class="queue-bar-track">
              <div class="queue-bar-fill" id="queueBar"></div>
            </div>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-label">Procesador</span>
            <span class="metric-icon">‚öôÔ∏è</span>
          </div>
          <div class="metric-value muted" id="workerVal">--</div>
          <div class="metric-sub" id="workerSub">Esperando datos...</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-label">Entorno</span>
            <span class="metric-icon">üåê</span>
          </div>
          <div class="metric-value" id="envVal" style="font-size: 1.1rem;">--</div>
          <div class="metric-sub" id="buildInfo">--</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-label">Trabajos Enviados</span>
            <span class="metric-icon">üì§</span>
          </div>
          <div class="metric-value success" id="jobsSentVal">0</div>
          <div class="metric-sub">Esta sesi√≥n</div>
        </div>
      </div>

      <div class="section-label">üìÑ Plantillas</div>
      <select id="templateSelect">
        <option value="simple">‚úÖ Texto Simple (Prueba B√°sica)</option>
        <option value="receipt">üßæ Ticket Completo</option>
        <option value="barcode">üìä Prueba de C√≥digo de Barras</option>
        <option value="qr">üì± Prueba de C√≥digo QR</option>
        <option value="table">üìã Prueba de Tablas</option>
        <option value="raw">‚ö° Comandos Raw ESC/POS</option>
        <option value="burstable">üî• Modo R√°faga (Sin Papel)</option>
      </select>
      <button class="btn" id="btnLoad">üì• Cargar Plantilla</button>

      <div class="section-label">üéØ Acciones</div>
      <button class="btn btn-primary" id="btnSend" disabled>üñ®Ô∏è Enviar Trabajo de Impresi√≥n</button>
      <button class="btn btn-danger" id="btnBurst" disabled>üî• Modo R√°faga (√ó10)</button>
      <div class="btn-group">
        <button class="btn" id="btnPing">üèì Ping</button>
        <button class="btn" id="btnStatus">üìä Estado</button>
      </div>

      <div class="troubleshoot-card" id="troubleshootCard">
        <div class="troubleshoot-header" id="troubleshootToggle">
          <span class="troubleshoot-header-text">
            <span>üîß</span>
            <span>Gu√≠a de Soluci√≥n de Problemas</span>
          </span>
          <span class="troubleshoot-chevron">‚ñº</span>
        </div>
        <div class="troubleshoot-body">
          <div class="troubleshoot-section">
            <h4>üî¥ Problemas de Conexi√≥n</h4>
            <ul>
              <li>Verificar servicio: <code>task status</code></li>
              <li>Revisar firewall puerto 8766</li>
              <li>Confirmar URL del WebSocket</li>
            </ul>
          </div>
          <div class="troubleshoot-section">
            <h4>üî¥ Fallos de Impresi√≥n</h4>
            <ul>
              <li>Revisar nombre en <code>profile.model</code></li>
              <li>Verificar servicio Print Spooler</li>
              <li>Revisar logs: <code>task logs</code></li>
            </ul>
          </div>
          <div class="troubleshoot-section">
            <h4>üî¥ Cola Llena</h4>
            <ul>
              <li>El worker podr√≠a estar atascado</li>
              <li>Impresora desconectada o error</li>
              <li>Reiniciar: <code>task restart</code></li>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <span class="panel-title-icon">üìù</span>
        Carga JSON (Payload)
      </div>
      <div class="json-status" id="jsonStatus">
        <span>‚è≥</span>
        <span>Verificando...</span>
      </div>
    </div>
    <div class="panel-content">
      <div class="editor-container">
        <textarea id="jsonEditor" spellcheck="false"
                  placeholder="Pega aqu√≠ el JSON de tu trabajo de impresi√≥n... "></textarea>
        <div class="editor-toolbar">
          <div class="editor-stats">
            <span class="editor-stat">
              <span>üìÑ</span>
              <span id="lineCount">0 l√≠neas</span>
            </span>
            <span class="editor-stat">
              <span>‚ö°</span>
              <span id="cmdCount">0 comandos</span>
            </span>
          </div>
          <div class="editor-actions">
            <button class="btn btn-sm" id="btnFormat">‚ú® Formatear</button>
            <button class="btn btn-sm" id="btnCopy">üìã Copiar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <span class="panel-title-icon">üìã</span>
        Log de Transacciones
      </div>
      <span id="logCount" style="font-size:  0.75rem; color: var(--text-muted);">0 entradas</span>
    </div>
    <div class="log-container" id="logContainer"></div>
    <div class="log-footer">
      <button class="btn btn-sm" id="btnClearLogs">üóëÔ∏è Limpiar</button>
      <button class="btn btn-sm" id="btnExportLogs">üì• Exportar</button>
    </div>
  </div>

</div>

<div class="modal-overlay" id="burstModal">
  <div class="modal-box">
    <div class="modal-icon">üî•</div>
    <div class="modal-title">Confirmar Modo R√°faga</div>
    <div class="modal-text">
      Esto enviar√° inmediatamente <strong>10 trabajos de impresi√≥n</strong> a la cola.
      <br><br>
      ‚ö†Ô∏è Usa la plantilla "Modo R√°faga" para evitar desperdicio de papel (solo pitidos).
    </div>
    <div class="modal-buttons">
      <button class="btn" id="btnBurstCancel">Cancelar</button>
      <button class="btn btn-danger" id="btnBurstConfirm">üî• Ejecutar</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
  /* ==============================================================
     CONFIGURACI√ìN
     ============================================================== */
  const CONFIG = {
    // [GU√çA DE INTEGRACI√ìN] URL del WebSocket. Puerto por defecto 8766.
    WS_URL: `ws://${window.location.hostname}:${window.location.port || 8766}/ws`,
    HEALTH_URL: `http://${window.location.hostname}:${window.location.port || 8766}/health`,
    POLL_INTERVAL: 2000,
    MAX_LOGS: 200,
    RECONNECT_DELAY: 3000
  };

  /* ==============================================================
     ESTADO (STATE)
     ============================================================== */
  const state = {
    socket: null,
    isConnected: false,
    jobsSent: 0,
    logCount: 0,
    pollTimer: null,
    startTime: Date.now()
  };

  /* ==============================================================
     ELEMENTOS DEL DOM
     ============================================================== */
  const el = {
    connStatus: document.getElementById('connStatus'),
    queueVal: document.getElementById('queueVal'),
    queueBar: document.getElementById('queueBar'),
    queuePct: document.getElementById('queuePct'),
    workerVal: document.getElementById('workerVal'),
    workerSub: document.getElementById('workerSub'),
    envVal: document.getElementById('envVal'),
    buildInfo: document.getElementById('buildInfo'),
    jobsSentVal: document.getElementById('jobsSentVal'),
    uptimeVal: document.getElementById('uptimeVal'),
    processedVal: document.getElementById('processedVal'),
    failedVal: document.getElementById('failedVal'),
    jsonEditor: document.getElementById('jsonEditor'),
    jsonStatus: document.getElementById('jsonStatus'),
    lineCount: document.getElementById('lineCount'),
    cmdCount: document.getElementById('cmdCount'),
    logContainer: document.getElementById('logContainer'),
    logCount: document.getElementById('logCount'),
    templateSelect: document.getElementById('templateSelect'),
    btnSend: document.getElementById('btnSend'),
    btnBurst: document.getElementById('btnBurst'),
    burstModal: document.getElementById('burstModal'),
    troubleshootCard: document.getElementById('troubleshootCard')
  };

  /* ==============================================================
     PLANTILLAS (TEMPLATES)
     [GU√çA DE INTEGRACI√ìN] Estructura requerida para los documentos de impresi√≥n
     ============================================================== */
  const TEMPLATES = {
    simple: {
      version: "1.0",
      profile: {model: "58mm PT-210", paper_width: 58},
      commands: [
        {
          type: "text",
          data: {content: {text: "PRUEBA DE CONEXI√ìN", align: "center", content_style: {bold: true, size: "2x1"}}}
        },
        {type: "text", data: {content: {text: new Date().toLocaleString(), align: "center"}}},
        {type: "feed", data: {lines: 3}},
        {type: "cut", data: {mode: "partial"}}
      ]
    },
    receipt: {
      version: "1.0",
      profile: {model: "58mm PT-210", paper_width: 58},
      commands: [
        {type: "text", data: {content: {text: "MI TIENDA", align: "center", content_style: {bold: true, size: "2x2"}}}},
        {type: "text", data: {content: {text: "Av. Principal 123", align: "center"}}},
        {type: "separator", data: {char: "-", length: 32}},
        {type: "text", data: {label: {text: "Fecha"}, content: {text: new Date().toLocaleDateString()}}},
        {type: "text", data: {label: {text: "Hora"}, content: {text: new Date().toLocaleTimeString()}}},
        {type: "separator", data: {char: ".", length: 32}},
        {
          type: "table",
          data: {
            definition: {columns: [{name: "Item", width: 16}, {name: "Precio", width: 10, align: "right"}]},
            rows: [["Cafe", "$35.00"], ["Muffin", "$25.00"]],
            options: {header_bold: true}
          }
        },
        {type: "separator", data: {char: "-", length: 32}},
        {type: "text", data: {content: {text: "TOTAL:  $60.00", align: "right", content_style: {bold: true}}}},
        {type: "feed", data: {lines: 1}},
        {type: "text", data: {content: {text: "¬°Gracias por su compra!", align: "center"}}},
        {type: "feed", data: {lines: 3}},
        {type: "cut", data: {mode: "partial"}}
      ]
    },
    barcode: {
      version: "1.0",
      profile: {model: "58mm PT-210", paper_width: 58},
      commands: [
        {type: "text", data: {content: {text: "PRUEBA C√ìDIGO BARRAS", align: "center", content_style: {bold: true}}}},
        {type: "feed", data: {lines: 1}},
        {
          type: "barcode",
          data: {symbology: "code128", data: "ABC123456", height: 60, hri_position: "below", align: "center"}
        },
        {type: "feed", data: {lines: 3}},
        {type: "cut", data: {mode: "partial"}}
      ]
    },
    qr: {
      version: "1.0",
      profile: {model: "58mm PT-210", paper_width: 58, has_qr: true},
      commands: [
        {type: "text", data: {content: {text: "PRUEBA C√ìDIGO QR", align: "center", content_style: {bold: true}}}},
        {type: "feed", data: {lines: 1}},
        {
          type: "qr",
          data: {
            data: "https://github.com/adcondev/ticket-daemon",
            human_text: "Escanear Docs",
            pixel_width: 150,
            align: "center"
          }
        },
        {type: "feed", data: {lines: 3}},
        {type: "cut", data: {mode: "partial"}}
      ]
    },
    table: {
      version: "1.0",
      profile: {model: "58mm PT-210", paper_width: 58},
      commands: [
        {type: "text", data: {content: {text: "PRUEBA DE TABLA", align: "center", content_style: {bold: true}}}},
        {type: "separator", data: {char: "=", length: 32}},
        {
          type: "table",
          data: {
            definition: {
              columns: [{name: "ID", width: 4}, {name: "Prod", width: 14}, {
                name: "Cant",
                width: 4,
                align: "right"
              }]
            },
            rows: [["01", "Pieza A", "5"], ["02", "Pieza B", "10"], ["03", "Pieza X", "3"]],
            options: {header_bold: true, column_spacing: 1}
          }
        },
        {type: "separator", data: {char: "=", length: 32}},
        {type: "feed", data: {lines: 3}},
        {type: "cut", data: {mode: "partial"}}
      ]
    },
    raw: {
      version: "1.0",
      profile: {model: "58mm PT-210", paper_width: 58},
      commands: [
        {type: "raw", data: {hex: "1B 40", comment: "Inicializar impresora", safe_mode: true}},
        {type: "text", data: {content: {text: "¬°Comando RAW ejecutado!", align: "center"}}},
        {type: "beep", data: {times: 2, lapse: 1}},
        {type: "feed", data: {lines: 3}},
        {type: "cut", data: {mode: "partial"}}
      ]
    },
    burstable: {
      version: "1.0",
      profile: {model: "58mm PT-210", paper_width: 58},
      commands: [
        {type: "beep", data: {times: 1, lapse: 1}}
      ]
    }
  };

  /* ==============================================================
     WEBSOCKET
     ============================================================== */
  function connectWebSocket() {
    addLog('INFO', `Conectando a ${CONFIG.WS_URL}...`);
    state.socket = new WebSocket(CONFIG.WS_URL);

    state.socket.onopen = () => {
      state.isConnected = true;
      updateConnectionUI(true);
      addLog('INFO', '‚úÖ Conectado al Ticket Daemon');
      showToast('Conectado al servicio', 'success');
      fetchHealth();
    };

    state.socket.onclose = () => {
      state.isConnected = false;
      updateConnectionUI(false);
      addLog('ERROR', '‚ùå Conexi√≥n perdida. Reintentando...');
      setTimeout(connectWebSocket, CONFIG.RECONNECT_DELAY);
    };

    state.socket.onerror = () => {
      addLog('ERROR', '‚ö†Ô∏è Error de WebSocket');
    };

    state.socket.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      } catch {
        addLog('INFO', event.data);
      }
    };
  }

  // [GU√çA DE INTEGRACI√ìN] Manejo de respuestas del servidor
  function handleMessage(msg) {
    const tipo = (msg.tipo || 'info').toLowerCase();

    switch (tipo) {
      case 'info':
        addLog('INFO', msg.mensaje || JSON.stringify(msg));
        break;
      case 'ack': // Confirmaci√≥n de que el trabajo entr√≥ a la cola
        addLog('ACK', `üì• Encolado: ${msg.id} (Posici√≥n: ${msg.current ?? 0}/${msg.capacity ?? 100})`);
        fetchHealth();
        break;
      case 'result': // Resultado final de la impresi√≥n (√©xito o fallo)
        if (msg.status === 'success') {
          addLog('RESULT', `‚úÖ Completado: ${msg.id} ‚Äî ${msg.mensaje}`, 'success');
          showToast('¬°Impresi√≥n completada! ', 'success');
        } else {
          addLog('ERROR', `‚ùå Fall√≥ [${msg.id}]: ${msg.mensaje}`, 'error');
          showToast('Error de impresi√≥n', 'error');
        }
        fetchHealth();
        break;
      case 'error': // Error inmediato (validaci√≥n, cola llena)
        addLog('ERROR', `‚ùå ${msg.mensaje}`);
        showToast(msg.mensaje, 'error');
        break;
      case 'pong':
        addLog('PONG', `üèì Pong (id: ${msg.id})`);
        break;
      case 'status':
        const current = msg.current ?? 0;
        const capacity = msg.capacity ?? 100;
        addLog('STATUS', `üìä Cola: ${current}/${capacity}`);
        updateQueueDisplay(current, capacity);
        break;
      default:
        addLog('INFO', JSON.stringify(msg));
    }
  }

  // [GU√çA DE INTEGRACI√ìN] Funci√≥n principal para enviar datos al servidor
  function sendMessage(msg) {
    if (!state.socket || !state.isConnected) {
      showToast('No conectado', 'error');
      return false;
    }
    state.socket.send(JSON.stringify(msg));
    return true;
  }

  /* ==============================================================
     POLLING DE SALUD (HEALTH)
     ============================================================== */
  async function fetchHealth() {
    try {
      const res = await fetch(CONFIG.HEALTH_URL);
      if (!res.ok) throw new Error('Health fall√≥');
      const data = await res.json();

      // Queue (Cola)
      const current = data.queue?.current || 0;
      const capacity = data.queue?.capacity || 100;
      updateQueueDisplay(current, capacity);

      // Worker (Procesador)
      const running = data.worker?.running;
      el.workerVal.textContent = running ? 'üü¢ Activo' : 'üî¥ Detenido';
      el.workerVal.className = 'metric-value ' + (running ? 'success' : 'error');

      const processed = data.worker?.jobs_processed || 0;
      const failed = data.worker?.jobs_failed || 0;
      el.workerSub.textContent = `${processed} procesados, ${failed} fallidos`;
      el.processedVal.textContent = processed;
      el.failedVal.textContent = failed;

      // Environment (Entorno)
      el.envVal.textContent = (data.build?.env || 'desconocido').toUpperCase();
      el.buildInfo.textContent = `Build: ${data.build?.date || '--'} ${data.build?.time || ''}`;

      // Uptime
      const uptime = data.uptime_seconds || 0;
      el.uptimeVal.textContent = formatUptime(uptime);

    } catch {
      el.workerVal.textContent = '‚ö´ Offline';
      el.workerVal.className = 'metric-value muted';
      el.workerSub.textContent = 'No se puede contactar al daemon';
    }
  }

  function updateQueueDisplay(current, capacity) {
    const pct = Math.round((current / capacity) * 100);
    el.queueVal.textContent = `${current} / ${capacity}`;
    el.queuePct.textContent = `${pct}%`;
    el.queueBar.style.width = `${pct}%`;
    el.queueBar.classList.toggle('warning', pct > 70);
  }

  function formatUptime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    if (h > 0) return `${h}h ${m}m`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
  }

  /* ==============================================================
     ACTUALIZACIONES DE UI
     ============================================================== */
  function updateConnectionUI(connected) {
    el.connStatus.className = 'conn-badge ' + (connected ? 'online' : 'offline');
    el.connStatus.innerHTML = `<span class="conn-dot"></span><span>${connected ? 'En L√≠nea' : 'Desconectado'}</span>`;
    el.btnSend.disabled = !connected;
    el.btnBurst.disabled = !connected;
  }

  /* ==============================================================
     LOGGING
     ============================================================== */
  function addLog(type, message, textClass = '') {
    const time = new Date().toLocaleTimeString('es-MX', {hour12: false});
    const entry = document.createElement('div');
    entry.className = 'log-entry';

    const badgeClass = type.toLowerCase();
    const msgClass = textClass ? `log-message ${textClass}-text` : 'log-message';

    entry.innerHTML = `
      <span class="log-time">${time}</span>
      <span class="log-badge ${badgeClass}">${type}</span>
      <span class="${msgClass}">${escapeHtml(message)}</span>
    `;

    el.logContainer.appendChild(entry);
    el.logContainer.scrollTop = el.logContainer.scrollHeight;

    state.logCount++;
    el.logCount.textContent = `${state.logCount} entradas`;

    while (el.logContainer.children.length > CONFIG.MAX_LOGS) {
      el.logContainer.removeChild(el.logContainer.firstChild);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  /* ==============================================================
     VALIDACI√ìN JSON
     ============================================================== */
  function validateJSON() {
    const input = el.jsonEditor.value;

    try {
      const doc = JSON.parse(input);
      const errors = [];

      if (!doc.version) errors.push('Falta versi√≥n');
      if (!doc.profile?.model) errors.push('Falta profile.model');
      if (!doc.commands?.length) errors.push('No hay comandos');

      if (errors.length > 0) {
        el.jsonStatus.className = 'json-status invalid';
        el.jsonStatus.innerHTML = `<span>‚ö†Ô∏è</span><span>${errors[0]}</span>`;
        return false;
      }

      el.jsonStatus.className = 'json-status valid';
      el.jsonStatus.innerHTML = '<span>‚úÖ</span><span>V√°lido</span>';

      el.lineCount.textContent = `${input.split('\n').length} l√≠neas`;
      el.cmdCount.textContent = `${doc.commands?.length || 0} comandos`;

      return true;
    } catch {
      el.jsonStatus.className = 'json-status invalid';
      el.jsonStatus.innerHTML = '<span>‚ùå</span><span>JSON Inv√°lido</span>';
      return false;
    }
  }

  /* ==============================================================
     TOASTS (Notificaciones)
     ============================================================== */
  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;

    const icons = {success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è'};
    toast.innerHTML = `
      <span class="toast-icon">${icons[type]}</span>
      <span class="toast-message">${escapeHtml(message)}</span>
    `;

    container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(100px)';
      setTimeout(() => toast.remove(), 300);
    }, 3500);
  }

  /* ==============================================================
     MANEJADORES DE EVENTOS (EVENT HANDLERS)
     ============================================================== */

  // Cargar Plantilla
  document.getElementById('btnLoad').addEventListener('click', () => {
    const key = el.templateSelect.value;
    const template = TEMPLATES[key];
    if (template) {
      el.jsonEditor.value = JSON.stringify(template, null, 2);
      validateJSON();
      addLog('INFO', `üìÑ Plantilla cargada: ${key}`);
    }
  });

  // Enviar Trabajo de Impresi√≥n
  // [GU√çA DE INTEGRACI√ìN] Ejemplo de env√≠o de un ticket
  el.btnSend.addEventListener('click', () => {
    if (!validateJSON()) {
      showToast('Corrije los errores del JSON primero', 'error');
      return;
    }

    try {
      const payload = JSON.parse(el.jsonEditor.value);
      const jobId = `job-${Date.now()}`;
      // Estructura del mensaje: { tipo: 'ticket', id: '...', datos: { ... } }
      const msg = {tipo: 'ticket', id: jobId, datos: payload};

      if (sendMessage(msg)) {
        addLog('SENT', `üì§ Trabajo:  ${jobId}`);
        state.jobsSent++;
        el.jobsSentVal.textContent = state.jobsSent;
      }
    } catch (e) {
      addLog('ERROR', `Env√≠o fallido: ${e.message}`);
    }
  });

  // Modo R√°faga
  el.btnBurst.addEventListener('click', () => {
    el.burstModal.classList.add('show');
  });

  document.getElementById('btnBurstCancel').addEventListener('click', () => {
    el.burstModal.classList.remove('show');
  });

  document.getElementById('btnBurstConfirm').addEventListener('click', () => {
    el.burstModal.classList.remove('show');

    let payload;
    try {
      payload = JSON.parse(el.jsonEditor.value);
    } catch {
      payload = TEMPLATES.burstable;
      addLog('INFO', '‚ö†Ô∏è Usando plantilla R√°faga');
    }

    addLog('INFO', 'üî• R√ÅFAGA: Enviando 10 trabajos...');

    for (let i = 0; i < 10; i++) {
      const jobId = `burst-${Date.now()}-${i}`;
      if (sendMessage({tipo: 'ticket', id: jobId, datos: payload})) {
        state.jobsSent++;
      }
    }

    el.jobsSentVal.textContent = state.jobsSent;
    showToast('R√°faga: ¬°10 trabajos enviados! ', 'warning');
    setTimeout(fetchHealth, 100);
  });

  // Ping
  document.getElementById('btnPing').addEventListener('click', () => {
    const id = `ping-${Date.now()}`;
    if (sendMessage({tipo: 'ping', id})) {
      addLog('SENT', `üèì Ping (${id})`);
    }
  });

  // Estado
  document.getElementById('btnStatus').addEventListener('click', () => {
    if (sendMessage({tipo: 'status'})) {
      addLog('SENT', 'üìä Solicitud de estado');
    }
  });

  // Actualizar (Refresh)
  document.getElementById('btnRefresh').addEventListener('click', () => {
    fetchHealth();
    showToast('Actualizado', 'info');
  });

  // Limpiar Logs
  document.getElementById('btnClearLogs').addEventListener('click', () => {
    el.logContainer.innerHTML = '';
    state.logCount = 0;
    el.logCount.textContent = '0 entradas';
  });

  // Exportar Logs
  document.getElementById('btnExportLogs').addEventListener('click', () => {
    const entries = el.logContainer.querySelectorAll('.log-entry');
    const lines = Array.from(entries).map(e => {
      const time = e.querySelector('.log-time').textContent;
      const type = e.querySelector('.log-badge').textContent;
      const msg = e.querySelector('.log-message').textContent;
      return `[${time}] ${type}: ${msg}`;
    });

    const blob = new Blob([lines.join('\n')], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ticket-daemon-${Date.now()}.log`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Logs exportados', 'success');
  });

  // Formatear JSON
  document.getElementById('btnFormat').addEventListener('click', () => {
    try {
      const doc = JSON.parse(el.jsonEditor.value);
      el.jsonEditor.value = JSON.stringify(doc, null, 2);
      validateJSON();
      showToast('Formateado', 'success');
    } catch {
      showToast('No se puede formatear JSON inv√°lido', 'error');
    }
  });

  // Copiar JSON
  document.getElementById('btnCopy').addEventListener('click', () => {
    navigator.clipboard.writeText(el.jsonEditor.value);
    showToast('Copiado al portapapeles', 'info');
  });

  // Toggle de Soluci√≥n de Problemas
  document.getElementById('troubleshootToggle').addEventListener('click', () => {
    el.troubleshootCard.classList.toggle('open');
  });

  // Validaci√≥n del editor al escribir
  el.jsonEditor.addEventListener('input', validateJSON);

  // Cerrar modal al hacer clic fuera
  el.burstModal.addEventListener('click', (e) => {
    if (e.target === el.burstModal) {
      el.burstModal.classList.remove('show');
    }
  });

  /* ==============================================================
     INICIALIZACI√ìN (INIT)
     ============================================================== */
  function init() {
    el.jsonEditor.value = JSON.stringify(TEMPLATES.simple, null, 2);
    validateJSON();
    connectWebSocket();
    state.pollTimer = setInterval(fetchHealth, CONFIG.POLL_INTERVAL);
    fetchHealth();
    addLog('INFO', 'üöÄ Dashboard inicializado');
  }

  init();
</script>
</body>
</html>